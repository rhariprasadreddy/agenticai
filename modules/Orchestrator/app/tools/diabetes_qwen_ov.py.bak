#!/usr/bin/env python3
"""
Client + router helpers for the diabetes OpenVINO Qwen service
running on the Xeon inference server.
"""

import os
import re
import requests

# URL of the Xeon diabetes OV service
# You can also override via env var: DIABETES_TOOL_URL
DIABETES_TOOL_URL = os.getenv(
    "DIABETES_TOOL_URL",
    "http://192.168.2.69:8080/generate",  # Xeon service
)

# Simple keyword-based diabetes intent detection
DIABETES_KEYWORDS = [
    r"\bdiabetes?\b",
    r"\btype[- ]?2\b",
    r"\btype[- ]?1\b",
    r"\bglucose\b",
    r"\bblood sugar\b",
    r"\bhyperglycemia\b",
    r"\bhypoglycemia\b",
    r"\binsulin\b",
    r"\bHbA1c\b",
]


def is_diabetes_query(text: str) -> bool:
    """Return True if the user query is likely about diabetes."""
    t = text.lower()
    for pat in DIABETES_KEYWORDS:
        if re.search(pat, t):
            return True
    return False


SAFETY_PREFIX = (
    "You are a conservative diabetes lifestyle assistant. "
    "You never change medications, doses or insulin regimens. "
    "You encourage the user to follow their doctor's advice and local guidelines. "
    "Focus on diet, exercise, general lifestyle and safety warnings.\n\n"
    "User question:\n"
)


def call_diabetes_qwen(prompt: str, max_new_tokens: int = 96) -> str:
    """
    Call the Xeon OV BF16 diabetes service via HTTP and
    return the completion text.
    """
    payload = {
        "prompt": SAFETY_PREFIX + prompt,
        "max_new_tokens": max_new_tokens,
    }
    resp = requests.post(DIABETES_TOOL_URL, json=payload, timeout=60)
    resp.raise_for_status()
    data = resp.json()
    return data.get("completion", "")
